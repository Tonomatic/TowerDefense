<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
  </head>
  <body>
    <script>
      // var config = {
      //     type: Phaser.AUTO,
      //     width: 800,
      //     height: 600,
      //     physics: {
      //         default: 'arcade',
      //         arcade: {
      //             gravity: { y: 200 }
      //         }
      //     },
      //     scene: {
      //         preload: preload,
      //         create: create
      //     }
      // };

      // var game = new Phaser.Game(config);

      // function preload ()
      // {
      //     this.load.setBaseURL('http://labs.phaser.io');

      //     this.load.image('sky', 'assets/skies/space3.png');
      //     this.load.image('logo', 'assets/sprites/phaser3-logo.png');
      //     this.load.image('red', 'assets/particles/red.png');
      // }

      // function create ()
      // {
      //     this.add.image(400, 300, 'sky');

      //     var particles = this.add.particles('red');

      //     var emitter = particles.createEmitter({
      //         speed: 100,
      //         scale: { start: 1, end: 0 },
      //         blendMode: 'ADD'
      //     });

      //     var logo = this.physics.add.image(400, 100, 'logo');

      //     logo.setVelocity(100, 200);
      //     logo.setBounce(1, 1);
      //     logo.setCollideWorldBounds(true);

      //     emitter.startFollow(logo);
      // }

      var config = {
        type: Phaser.AUTO,
        parent: "content",
        width: 640,
        height: 512,
        scene: {
          key: "main",
          preload: preload,
          create: create,
          update: update,
        },
      };
      var game = new Phaser.Game(config);
      var graphics;
      var path;

      function preload() {
        this.load.atlas("sprites", "images/circle.png");
        this.load.image("bullet", "images/blue-circle.png");
      }
      var ENEMY_SPEED = 1 / 10000;

      var map = [
        [0, -1, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, -1, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, -1, -1, -1, -1, -1, -1, -1, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, -1, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, -1, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, -1, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, -1, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, -1, 0, 0],
      ];

      var Enemy = new Phaser.Class({
        Extends: Phaser.GameObjects.Image,

        initialize: function Enemy(scene) {
          Phaser.GameObjects.Image.call(this, scene, 0, 0, "sprites", "enemy");
          this.follower = { t: 0, vec: new Phaser.Math.Vector2() };
        },
        startOnPath: function () {
          this.follower.t = 0;

          path.getPoint(this.follower.t, this.follower.vec);

          this.setPosition(this.follower.vec.x, this.follower.vec.y);
        },
        update: function (time, delta) {
          // move the t point along the path, 0 is the start and 0 is the end
          this.follower.t += ENEMY_SPEED * delta;

          // get the new x and y coordinates in vec
          path.getPoint(this.follower.t, this.follower.vec);

          // update enemy x and y to the newly obtained x and y
          this.setPosition(this.follower.vec.x, this.follower.vec.y);
          // if we have reached the end of the path, remove the enemy
          if (this.follower.t >= 1) {
            this.setActive(false);
            this.setVisible(false);
          }
        },
      });

      var Turret = new Phaser.Class({
        Extends: Phaser.GameObjects.Image,
        initialize: function Turret(scene) {
          Phaser.GameObjects.Image.call(this, scene, 0, 0, "sprites", "turret");
          this.nextTic = 0;
        },
        //then we place the turret according to the grid
        place: function (i, j) {
          this.y = i * 64 + 64 / 2;
          this.x = j * 64 + 64 / 2;
          map[i][j] = 1;
        },
        update: function (time, delta) {
          if (time > this.nextTic) {
            this.nextTic = time + 1000;
          }
        },
      });

      //making a drawgrid function
      function drawGrid(graphics) {
        graphics.lineStyle(1, 0x0000ff, 0.8);
        for (let i = 0; i < 8; i++) {
          graphics.moveTo(0, i * 64);
          graphics.lineTo(640, i * 64);
        }
        for (let j = 0; j < 10; j++) {
          graphics.moveTo(j * 64, 0);
          graphics.lineTo(j * 64, 512);
        }

        graphics.strokePath();
      }

      function placeTurret(pointer) {
        var i = Math.floor(pointer.y / 64);
        var j = Math.floor(pointer.x / 64);
        if (canPlaceTurret(i, j)) {
          var turret = turrets.get();
          if (turret) {
            turret.setActive(true);
            turret.setVisible(true);
            turret.place(i, j);
          }
        }
      }

      function canPlaceTurret(i, j) {
        return map[i][j] === 0;
      }

      function create() {
        // this graphics element is only for visualization,
        // its not related to our path
        var graphics = this.add.graphics();
        drawGrid(graphics);
        // the path for our enemies
        // parameters are the start x and y of our path
        path = this.add.path(96, -32);
        path.lineTo(96, 164);
        path.lineTo(480, 164);
        path.lineTo(480, 544);

        graphics.lineStyle(3, 0xffffff, 1);
        // visualize the path
        path.draw(graphics);
        enemies = this.add.group({ classType: Enemy, runChildUpdate: true });
        this.nextEnemy = 0;
        turrets = this.add.group({ classType: Turret, runChildUpdate: true });
        this.input.on("pointerdown", placeTurret);
      }

      function update(time, delta) {
        // if its time for the next enemy
        if (time > this.nextEnemy) {
          var enemy = enemies.get();
          if (enemy) {
            enemy.setActive(true);
            enemy.setVisible(true);

            // place the enemy at the start of the path
            enemy.startOnPath();

            this.nextEnemy = time + 2000;
          }
        }
      }
    </script>
  </body>
</html>
